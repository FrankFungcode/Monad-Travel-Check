/**
 * @file AttractionCheckinPage Component
 * @description Page for completing an attraction check-in task
 */

import { Button } from '@/components/common/Button'
import { Card } from '@/components/common/Card'
import { Modal } from '@/components/common/Modal'
import { useAttraction } from '@/hooks/useAttraction'
import { useWallet } from '@/hooks/useWallet'
import { useState, useEffect } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { ethers } from 'ethers'

/**
 * AttractionCheckinPage Component
 */
export function AttractionCheckinPage() {
    const { taskId } = useParams<{ taskId: string }>()
    const navigate = useNavigate()
    const { isConnected, address, connect } = useWallet()
    const { getTask, getContract, getUserTaskInfo } = useAttraction()

    const [task, setTask] = useState<any>(null)
    const [loading, setLoading] = useState(false)
    const [verifying, setVerifying] = useState(false)
    const [location, setLocation] = useState<{ lat: number; lng: number } | null>(null)
    const [distance, setDistance] = useState<number | null>(null)
    const [showSuccessModal, setShowSuccessModal] = useState(false)

    // Load task details
    useEffect(() => {
        const loadData = async () => {
            if (!taskId) return
            const taskData = await getTask(taskId)
            setTask(taskData)

            // Check if already completed
            if (address) {
                const info = await getUserTaskInfo(taskId, address)
                if (info?.completed) {
                    alert('You have already completed this task!')
                    navigate('/attractions')
                }
            }
        }
        loadData()
    }, [taskId, getTask, getUserTaskInfo, address, navigate])

    const handleGetLocation = () => {
        setVerifying(true)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude
                    const userLng = position.coords.longitude
                    setLocation({ lat: userLat, lng: userLng })

                    if (task) {
                        // Calculate distance (simple Haversine or approximation)
                        // For MVP, simplistic distance calculation
                        const R = 6371e3; // metres
                        const Ï†1 = userLat * Math.PI / 180;
                        const Ï†2 = task.location.lat * Math.PI / 180;
                        const Î”Ï† = (task.location.lat - userLat) * Math.PI / 180;
                        const Î”Î» = (task.location.lng - userLng) * Math.PI / 180;

                        const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                            Math.cos(Ï†1) * Math.cos(Ï†2) *
                            Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        const d = R * c; // in metres

                        setDistance(d)
                    }
                    setVerifying(false)
                },
                (error) => {
                    alert(`è·å–ä½ç½®å¤±è´¥: ${error.message}`)
                    setVerifying(false)
                }
            )
        } else {
            alert('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®')
            setVerifying(false)
        }
    }

    const handleCheckin = async () => {
        if (!isConnected) {
            await connect()
            return
        }

        if (!location) {
            alert('è¯·å…ˆè·å–ä½ç½®éªŒè¯')
            return
        }

        /* 
        NOTE: In a real production app, the signature MUST be generated by a secure backend service.
        The backend would verify the GPS coordinates and then sign the data.
        For this purely frontend demo/test, we are simulating the backend using the Owner's private key.
        WARNING: NEVER EXPOSE PRIVATE KEYS IN PRODUCTION FRONTEND CODE.
        */
        const TEST_SIGNER_PRIVATE_KEY = "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" // Hardhat Account #0

        setLoading(true)
        try {
            const contract = await getContract()
            if (!contract) throw new Error("Contract not available")

            // 1. Prepare data
            const contentHash = ethers.keccak256(ethers.toUtf8Bytes("FrontendCheckin"))
            const latInt = Math.round(location.lat * 1000000)
            const lngInt = Math.round(location.lng * 1000000)
            const expiry = Math.floor(Date.now() / 1000) + 300 // 5 mins expiry

            // 2. Generate Signature (Simulating Backend)
            const wallet = new ethers.Wallet(TEST_SIGNER_PRIVATE_KEY)

            // abi.encodePacked(taskId, msg.sender, contentHash, latitude, longitude, expiry)
            const messageHash = ethers.solidityPackedKeccak256(
                ['uint256', 'address', 'bytes32', 'int256', 'int256', 'uint256'],
                [taskId, address, contentHash, latInt, lngInt, expiry]
            )
            const messageBytes = ethers.getBytes(messageHash)
            const signature = await wallet.signMessage(messageBytes)

            console.log("Generated Signature:", signature)

            // 3. Call Contract completeTask
            const tx = await contract.completeTask(
                taskId,
                contentHash,
                latInt,
                lngInt,
                expiry,
                signature
            )

            console.log("Check-in Tx:", tx.hash)
            await tx.wait()

            // alert("æ‰“å¡æˆåŠŸï¼å¥–åŠ±å·²å‘æ”¾ï¼") 
            // Replace alert with modal
            setShowSuccessModal(true)

        } catch (error) {
            console.error("Check-in failed:", error)
            const msg = error instanceof Error ? error.message : "Unknown error"
            alert(`æ‰“å¡å¤±è´¥: ${msg}`) // Keep error alert for now or replace? User asked for Success modal specifically.
        } finally {
            setLoading(false)
        }
    }

    if (!task) return <div className="text-center p-10 text-white">Loading task...</div>

    return (
        <div className="max-w-md mx-auto space-y-6">
            <div>
                <h1 className="text-3xl font-bold text-white mb-2">æ™¯ç‚¹æ‰“å¡</h1>
                <p className="text-text-muted">éªŒè¯æ‚¨çš„ä½ç½®ä»¥å®Œæˆä»»åŠ¡</p>
            </div>

            <Card>
                <div className="relative h-48 -m-4 mb-4 overflow-hidden rounded-t-lg">
                    <img src={task.coverImage} alt={task.name} className="w-full h-full object-cover" />
                    <div className="absolute inset-0 bg-gradient-to-t from-background-dark/80 to-transparent" />
                    <div className="absolute bottom-4 left-4">
                        <h2 className="text-xl font-bold text-white">{task.name}</h2>
                        <p className="text-sm text-gray-300">{task.location.name}</p>
                    </div>
                </div>

                <Card.Body className="space-y-6">
                    {/* Location Verification */}
                    <div className="bg-primary-900/20 p-4 rounded-lg border border-primary-500/30">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-gray-300">å½“å‰ä½ç½®</span>
                            {location && (
                                <span className="text-xs text-primary font-mono">
                                    {location.lat.toFixed(6)}, {location.lng.toFixed(6)}
                                </span>
                            )}
                        </div>

                        {!location ? (
                            <Button
                                variant="outline"
                                fullWidth
                                onClick={handleGetLocation}
                                loading={verifying}
                            >
                                ğŸ“ è·å–å¹¶éªŒè¯ä½ç½®
                            </Button>
                        ) : (
                            <div className="text-center space-y-2">
                                <div className={`text-lg font-bold ${distance !== null && distance <= task.location.radius ? 'text-green-500' : 'text-red-500'}`}>
                                    {distance !== null ? `è·ç¦»ç›®æ ‡ ${Math.round(distance)} ç±³` : 'è®¡ç®—ä¸­...'}
                                </div>
                                <p className="text-xs text-gray-400">æ‰“å¡èŒƒå›´: {task.location.radius} ç±³</p>

                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={handleGetLocation}
                                    loading={verifying}
                                >
                                    ğŸ”„ é‡æ–°å®šä½
                                </Button>
                            </div>
                        )}
                    </div>

                    {/* Check-in Button */}
                    <Button
                        variant="primary"
                        fullWidth
                        size="lg"
                        disabled={!location || loading || (distance !== null && distance > task.location.radius)}
                        loading={loading}
                        onClick={handleCheckin}
                    >
                        {loading ? 'æ­£åœ¨æ‰“å¡...' : 'ç¡®è®¤æ‰“å¡'}
                    </Button>

                    {distance !== null && distance > task.location.radius && (
                        <p className="text-center text-xs text-red-400">
                            æ‚¨ä¸åœ¨æ‰“å¡èŒƒå›´å†…ï¼Œè¯·ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®é™„è¿‘ã€‚
                        </p>
                    )}
                </Card.Body>
            </Card>

            {/* Success Modal */}
            <Modal
                isOpen={showSuccessModal}
                onClose={() => {
                    setShowSuccessModal(false)
                    navigate('/attractions') // Or stay? Usually navigate out.
                }}
                title="ğŸ† æ‰“å¡æˆåŠŸ"
                size="sm"
            >
                <div className="text-center space-y-6 py-4">
                    <div className="text-6xl animate-bounce">
                        ğŸ‰
                    </div>

                    <div className="space-y-2">
                        <h3 className="text-xl font-bold text-white">æ­å–œæ‚¨å®Œæˆä»»åŠ¡ï¼</h3>
                        <p className="text-text-muted">å¥–åŠ±å·²è‡ªåŠ¨å‘é€åˆ°æ‚¨çš„é’±åŒ…</p>
                    </div>

                    <div className="bg-primary-900/30 border border-primary-500/50 rounded-xl p-4">
                        <p className="text-sm text-text-muted mb-1">è·å¾—å¥–åŠ±</p>
                        <p className="text-3xl font-bold text-primary">
                            {task.rewardAmount} <span className="text-lg">MON</span>
                        </p>
                    </div>

                    <div className="pt-2">
                        <Button
                            variant="primary"
                            fullWidth
                            onClick={() => navigate('/rewards')}
                        >
                            æŸ¥çœ‹æˆ‘çš„å¥–åŠ±
                        </Button>
                        <button
                            className="mt-4 text-sm text-text-muted hover:text-white underline"
                            onClick={() => navigate('/attractions')}
                        >
                            è¿”å›ä»»åŠ¡åˆ—è¡¨
                        </button>
                    </div>
                </div>
            </Modal>
        </div>
    )
}
